<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zen Seifenblasen-Popper</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Tone.js (fÃ¼r Hintergrundmusik) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
        :root {
            --bg-color: #0d1117;
            --zen-color-1: rgba(147, 197, 253, 0.4);
            --zen-color-2: rgba(200, 150, 250, 0.4);
            --zen-color-3: rgba(160, 250, 160, 0.4);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            cursor: crosshair;
        }

        .bubble {
            position: absolute;
            border-radius: 50%;
            box-shadow: 
                inset 0 0 10px rgba(255, 255, 255, 0.8),
                0 0 15px rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out, border 0.2s ease-out, box-shadow 0.2s ease-out; 
            backdrop-filter: blur(2px);
            will-change: transform, left, top;
            z-index: 10;
            user-select: none;
        }

        .bubble.zen-1 { background: radial-gradient(circle at 70% 30%, var(--zen-color-1), transparent); }
        .bubble.zen-2 { background: radial-gradient(circle at 70% 30%, var(--zen-color-2), transparent); }
        .bubble.zen-3 { background: radial-gradient(circle at 70% 30%, var(--zen-color-3), transparent); }
        
        .bubble.special-vocab {
            background: radial-gradient(circle at 70% 30%, rgba(255, 165, 0, 0.7), transparent);
            border: 3px solid rgba(255, 140, 0, 0.9);
            box-shadow: 0 0 10px #ff8c00, inset 0 0 5px #ffffff;
            display: flex; 
            align-items: center;
            justify-content: center;
            font-weight: 600; 
            font-size: 1.0rem; 
            color: #fef3c7; 
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8), 0 0 1px rgba(255, 255, 255, 0.5); 
            z-index: 20; 
        }

        .bubble-text {
            pointer-events: none; 
            text-align: center;
            padding: 5px;
            line-height: 1.1;
        }

        .bubble.popped {
            opacity: 0;
            transform: scale(2.0) rotate(5deg); 
            border: 0px solid rgba(255, 255, 255, 0.0);
            box-shadow: none;
            transition: opacity 0.1s ease-out, transform 0.1s ease-out;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: rgba(147, 197, 253, 0.8);
            z-index: 50;
            pointer-events: none;
            will-change: transform, opacity;
        }

        #zen-buddha-bg {
            z-index: 1;
            opacity: 0.1;
            filter: grayscale(100%);
            pointer-events: none;
            background-image: url("https://joboent.github.io/vokabeltrainer/buddha.png");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
        }

        .score-glow {
            text-shadow: 0 0 8px rgba(45, 212, 191, 0.8), 0 0 15px rgba(45, 212, 191, 0.4);
        }

        .streak-message {
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.5s, transform 0.5s;
        }

        .streak-visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-900 h-screen w-screen overflow-hidden text-gray-200 antialiased relative">

    <div id="game-area" class="w-full h-full relative">
        <div id="zen-buddha-bg" class="zen-bg-image"></div>

        <div class="absolute top-4 left-4 p-3 bg-gray-800/70 backdrop-blur-sm rounded-xl shadow-lg z-50">
            <h2 class="text-sm font-light leading-none">Punkte: 
                <span id="score" class="text-base font-semibold text-teal-400 score-glow">0</span>
            </h2>
            <div id="streak-info" class="mt-1 text-xs text-yellow-400 transition-all duration-300 h-4"></div>
        </div>
        
        <div class="absolute top-4 right-4 z-50">
            <button id="audio-toggle" title="Hintergrundmusik an/aus" class="p-3 bg-gray-800/70 backdrop-blur-sm rounded-full text-white hover:bg-gray-700 transition duration-200 shadow-lg">
                <span id="audio-icon">ðŸ”ˆ</span>
            </button>
        </div>
    </div>

    <script>
        const GAME_AREA = document.getElementById('game-area');
        const SCORE_DISPLAY = document.getElementById('score');
        const STREAK_INFO = document.getElementById('streak-info');
        const AUDIO_TOGGLE = document.getElementById('audio-toggle');
        const AUDIO_ICON = document.getElementById('audio-icon');
        const BUBBLE_COLORS = ['zen-1', 'zen-2', 'zen-3'];
        const AMBIENT_NOTES = ["C3", "E3", "G3", "C4"];
        
        let score = 0;
        let lastColor = null;
        let streakCount = 0;
        let bubbles = [];
        let particles = []; 
        let bubbleIdCounter = 0;
        let lastFrameTime = performance.now();
        let isPlayingMusic = false;
        
        let gameLoopId = null;
        let bubbleIntervalId = null;
        let hasSpecialBubble = false; 
        
        // --- TONE.JS AUDIO SETUP ---
        let musicSynth, heartbeatSynth;
        let tremolo, chorus;

        function setupAudio() {
            // 1. Effekte fÃ¼r den schwingenden Ambient-Sound
            tremolo = new Tone.Tremolo(0.2, 0.5).start(); 
            chorus = new Tone.Chorus(0.5, 3.5, 0.8).start();

            // 2. Hintergrundmusik Synth (PolySynth ermÃ¶glicht das gleichzeitige Spielen von Noten-Arrays)
            musicSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 4,
                    decay: 0.1,
                    sustain: 1.0,
                    release: 4
                },
                volume: -22
            }).connect(tremolo);
            
            tremolo.connect(chorus);
            chorus.toDestination();

            // 3. Herzschlag-Synth (Tiefer, weicher Sinus-Kick)
            heartbeatSynth = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 2,
                oscillator: { type: "sine" },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.01, release: 0.2 },
                volume: -24
            }).toDestination();

            // Rhythmus-Schleife fÃ¼r Herzschlag (Lubb-Dupp ... Pause)
            // 60 BPM (Ein Zyklus alle 2 Sekunden)
            Tone.Transport.scheduleRepeat((time) => {
                // Erster Schlag (Lubb)
                heartbeatSynth.triggerAttackRelease("C1", "16n", time);
                // Zweiter Schlag (Dupp) kurz darauf
                heartbeatSynth.triggerAttackRelease("B0", "16n", time + 0.35);
            }, "2s");
        }

        function toggleAudio() {
            // Tone.start() muss bei einer Nutzerinteraktion aufgerufen werden
            if (Tone.context.state !== 'running') {
                Tone.start();
            }

            if (isPlayingMusic) {
                // Sanftes Ausblenden der Noten
                musicSynth.releaseAll(); 
                Tone.Transport.pause();
                isPlayingMusic = false;
                AUDIO_ICON.textContent = 'ðŸ”ˆ';
            } else {
                // Startet den Akkord (Ambient-Teppich)
                musicSynth.triggerAttack(AMBIENT_NOTES);
                Tone.Transport.start();
                isPlayingMusic = true;
                AUDIO_ICON.textContent = 'ðŸ”Š';
            }
        }

        // --- PARTIKEL LOGIC ---
        function createParticles(x, y, size) {
            const numParticles = 8 + Math.floor(size / 30);
            for (let i = 0; i < numParticles; i++) {
                const element = document.createElement('div');
                element.classList.add('particle');
                const pSize = random(2, 5); 
                element.style.width = `${pSize}px`;
                element.style.height = `${pSize}px`;
                const angle = random(0, Math.PI * 2);
                const initialSpeed = random(2, 6);
                const dx = Math.cos(angle) * initialSpeed;
                const dy = Math.sin(angle) * initialSpeed;
                const startX = x + size / 2;
                const startY = y + size / 2;
                element.style.transform = `translate(${startX}px, ${startY}px)`;
                GAME_AREA.appendChild(element);
                particles.push({ element, x: startX, y: startY, dx, dy, life: 1.0, gravity: 0.2 });
            }
        }
        
        function moveParticles(deltaTime) {
            const timeFactor = deltaTime / 16.66;
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.dx *= 0.98;
                p.dy += p.gravity * timeFactor;
                p.x += p.dx * timeFactor;
                p.y += p.dy * timeFactor;
                p.life -= 0.05 * timeFactor;
                if (p.life <= 0) {
                    p.element.remove();
                    particles.splice(i, 1);
                } else {
                    p.element.style.transform = `translate(${p.x}px, ${p.y}px)`;
                    p.element.style.opacity = p.life;
                }
            }
        }

        function initGame() {
            setupAudio();
            AUDIO_TOGGLE.addEventListener('click', toggleAudio);
            startGame();
        }

        function startGame() {
            GAME_AREA.addEventListener('click', popBubble);
            bubbleIntervalId = setInterval(createBubble, 600); 
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function random(min, max) { return Math.random() * (max - min) + min; }

        function createBubble() {
            let isSpecial = Math.random() < 0.025 && !hasSpecialBubble; 
            const size = isSpecial ? random(100, 180) : random(50, 150); 
            const color = isSpecial ? 'special-vocab' : BUBBLE_COLORS[Math.floor(random(0, BUBBLE_COLORS.length))];
            
            let x, y, dx, dy;
            const side = Math.floor(random(0, 4));
            const speed = random(0.5, 1.5);
            const margin = 0.1;

            if (side === 0) { x = random(window.innerWidth*margin, window.innerWidth*(1-margin)); y = -size; dx = random(-0.5, 0.5); dy = speed; }
            else if (side === 1) { x = window.innerWidth + size; y = random(window.innerHeight*margin, window.innerHeight*(1-margin)); dx = -speed; dy = random(-0.5, 0.5); }
            else if (side === 2) { x = random(window.innerWidth*margin, window.innerWidth*(1-margin)); y = window.innerHeight + size; dx = random(-0.5, 0.5); dy = -speed; }
            else { x = -size; y = random(window.innerHeight*margin, window.innerHeight*(1-margin)); dx = speed; dy = random(-0.5, 0.5); }

            const element = document.createElement('div');
            element.classList.add('bubble', color);
            element.style.width = `${size}px`;
            element.style.height = `${size}px`;
            element.style.transform = `translate(${x}px, ${y}px)`;
            element.dataset.color = color;

            if (isSpecial) {
                element.dataset.special = 'true';
                hasSpecialBubble = true;
                const text = document.createElement('span');
                text.classList.add('bubble-text');
                text.textContent = 'Bereit fÃ¼r Vokabeln';
                element.appendChild(text);
            }

            GAME_AREA.appendChild(element);
            bubbles.push({ x, y, dx, dy, size, element });
        }

        function moveBubbles(deltaTime) {
            const timeFactor = deltaTime / 16.66;
            for (let i = bubbles.length - 1; i >= 0; i--) {
                const b = bubbles[i];
                b.x += b.dx * timeFactor;
                b.y += b.dy * timeFactor;
                b.element.style.transform = `translate(${b.x}px, ${b.y}px)`;
                if (b.x < -b.size-200 || b.x > window.innerWidth+200 || b.y < -b.size-200 || b.y > window.innerHeight+200) {
                    if (b.element.dataset.special === 'true') hasSpecialBubble = false;
                    b.element.remove();
                    bubbles.splice(i, 1);
                }
            }
        }
        
        function popBubble(event) {
            const element = event.target.closest('.bubble');
            if (!element || element.classList.contains('popped')) return;
            const idx = bubbles.findIndex(b => b.element === element);
            const bData = bubbles[idx];
            createParticles(bData.x, bData.y, bData.size);

            if (element.dataset.special === 'true') {
                hasSpecialBubble = false;
                endGame();
                return;
            }

            const color = element.dataset.color;
            let currentPoints = color === lastColor ? 10 * (1 + Math.floor(++streakCount/5)) : (streakCount=1, lastColor=color, 10);
            score += currentPoints;
            SCORE_DISPLAY.textContent = score;
            showStreakMessage(streakCount, currentPoints, streakCount === 1);
            element.classList.add('popped');
            setTimeout(() => { element.remove(); bubbles.splice(idx, 1); }, 100);
        }

        function endGame() {
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            if (bubbleIntervalId) clearInterval(bubbleIntervalId);
            if (musicSynth) musicSynth.releaseAll();
            Tone.Transport.stop();
            GAME_AREA.innerHTML += `<div class="absolute inset-0 flex items-center justify-center bg-gray-900/90 z-50"><div class="bg-teal-700 text-white p-8 rounded-xl text-center border-4 border-teal-400"><h1 class="text-3xl font-bold mb-4">Bereit fÃ¼r den Vokabeltrainer!</h1><p class="text-lg">Punkte: ${score}</p></div></div>`;
        }

        function showStreakMessage(count, points, reset) {
            STREAK_INFO.classList.remove('streak-visible'); 
            STREAK_INFO.innerHTML = count < 2 || reset ? `<span class="text-gray-400">+${points}</span>` : `<span class="font-bold">${count >= 10 ? 'Zen-Meister!' : (count >= 5 ? 'Im Fluss!' : 'Streak!')}</span><span class="text-sm text-yellow-300 ml-1">${count}x</span><span class="text-teal-400 ml-2">(+${points})</span>`;
            setTimeout(() => STREAK_INFO.classList.add('streak-visible'), 10); 
        }

        function gameLoop(currentTime) {
            const deltaTime = currentTime - lastFrameTime;
            lastFrameTime = currentTime;
            moveBubbles(deltaTime);
            moveParticles(deltaTime);
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        window.onload = initGame;
    </script>
</body>
</html>